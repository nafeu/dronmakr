<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚îå dronmakr v{{ version }} ‚ñ† beatbuildr ‚îê</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•Å</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:ital@0;1&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    crossorigin="anonymous">
  <style>
    :root {
      --secondary: #000000;
      --primary: #ff9505;
      --theme-a: #353531;
      --theme-b: #016fb9;
      --theme-c: #ec4e20;
      --toolbar-height: 48px;
      --grid-cell-size: 28px;
      /* Width of the row/sample label column (header + each row); change to resize. */
      --grid-label-width: 280px;
    }

    body {
      background-color: var(--secondary);
      color: var(--primary);
      font-family: "Fragment Mono", monospace;
      padding: 1rem;
      padding-top: calc(var(--toolbar-height) + 1rem);
      user-select: none;
      -webkit-user-select: none;
    }

    #sequencer-grid,
    #sequencer-grid * {
      user-select: none;
      -webkit-user-select: none;
    }

    /* Themed scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--theme-a) var(--secondary);
    }

    *::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    *::-webkit-scrollbar-track {
      background: var(--secondary);
    }

    *::-webkit-scrollbar-thumb {
      background: var(--theme-a);
      border-radius: 4px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--theme-b);
    }

    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--toolbar-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      background-color: var(--secondary);
      border-bottom: 1px solid var(--theme-a);
      z-index: 1000;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    #toolbar-brand {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--primary);
      min-width: 20ch;
      flex-shrink: 0;
      text-decoration: none;
      outline: none;
    }

    #toolbar-brand:hover,
    #toolbar-brand:focus,
    #toolbar-brand:visited {
      color: var(--primary);
      text-decoration: none;
    }

    .toolbar-nav {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .toolbar-nav a {
      color: var(--primary);
      text-decoration: none;
      padding: 0.35rem 0.65rem;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      background: var(--theme-a);
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .toolbar-nav a:hover {
      border-color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .toolbar-nav a:active {
      background: rgba(255, 149, 5, 0.25);
    }

    .toolbar-nav a.active {
      border-color: var(--primary);
      background: var(--primary);
      color: var(--secondary);
    }

    .toolbar-nav a.active:hover {
      background: #ff8900;
      border-color: #ff8900;
    }

    .toolbar-nav a.active:active {
      background: #e67e00;
      border-color: #e67e00;
    }

    #toolbar-status {
      font-size: 0.75rem;
      color: var(--theme-b);
    }

    #app-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(220px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    #main-column {
      border: 1px solid var(--theme-a);
      padding: 0.75rem;
      border-radius: 4px;
      background: #050505;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #sidebar-column {
      border: 1px solid var(--theme-a);
      padding: 0.75rem;
      border-radius: 4px;
      background: #050505;
      min-height: 200px;
    }

    #sidebar-column h2 {
      margin: 0;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    #sidebar-column h2 i {
      font-size: 0.75rem;
    }

    .sidebar-section-divider {
      height: 1px;
      background: var(--theme-a);
      margin: 0.75rem 0;
    }

    .sidebar-section-label {
      margin: 0;
      margin-bottom: 0.5rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .sidebar-section-label i {
      font-size: 0.65rem;
    }

    #sidebar-empty-note {
      font-size: 0.75rem;
      color: var(--theme-a);
    }

    .transport-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .transport-btn {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid;
      flex-shrink: 0;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, opacity 0.15s ease,
        transform 0.08s ease;
    }

    .transport-btn i {
      pointer-events: none;
    }

    .transport-btn-primary {
      background: var(--primary);
      color: var(--secondary);
      border-color: var(--primary);
    }

    .transport-btn-primary:not(:disabled):hover {
      background: #ff8900;
      border-color: #ff8900;
    }

    .transport-btn-primary:not(:disabled):active {
      background: #e67e00;
      border-color: #e67e00;
      transform: scale(0.96);
    }

    .transport-btn-secondary {
      background: #050505;
      color: var(--primary);
      border-color: var(--theme-a);
    }

    .transport-btn-secondary:not(:disabled):hover {
      background: rgba(255, 149, 5, 0.12);
      border-color: var(--primary);
    }

    .transport-btn-secondary:not(:disabled):active {
      background: rgba(255, 149, 5, 0.2);
      border-color: var(--primary);
      transform: scale(0.96);
    }

    .transport-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .transport-tempo {
      margin-bottom: 0.5rem;
    }

    .transport-tempo label {
      display: block;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }

    .transport-tempo input[type="number"] {
      width: 100%;
      min-height: 2.5rem;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 1.25rem;
      font-weight: 600;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
    }

    .transport-tempo input[type="number"]:focus {
      outline: none;
      border-color: var(--theme-b);
      box-shadow: 0 0 0 1px var(--theme-b);
    }

    .transport-swing {
      margin-bottom: 0.5rem;
    }

    .transport-swing label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }

    .swing-value {
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 600;
    }

    .swing-slider-wrapper {
      position: relative;
      width: 100%;
      height: 2.5rem;
      display: flex;
      align-items: center;
    }

    .swing-fake-track {
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--secondary);
      pointer-events: none;
      z-index: 1;
    }

    .transport-swing input[type="range"] {
      position: relative;
      width: 100%;
      height: 100%;
      background: transparent;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      z-index: 2;
    }

    .transport-swing input[type="range"]::-webkit-slider-track {
      background: transparent;
      border: none;
    }

    .transport-swing input[type="range"]::-moz-range-track {
      background: transparent;
      border: none;
    }

    .transport-swing input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border: 2px solid var(--secondary);
      border-radius: 50%;
      cursor: pointer;
    }

    .transport-swing input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--primary);
      border: 2px solid var(--secondary);
      border-radius: 50%;
      cursor: pointer;
    }

    .transport-swing input[type="range"]:focus {
      outline: none;
    }

    .transport-setting {
      margin-bottom: 0.5rem;
    }

    .transport-setting label {
      display: block;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }

    .transport-setting select,
    .transport-setting input[type="number"] {
      width: 100%;
      min-height: 2.5rem;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.95rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
    }

    .transport-setting select:focus,
    .transport-setting input[type="number"]:focus {
      outline: none;
      border-color: var(--theme-b);
    }

    .transport-export-actions {
      margin: 0.5rem 0;
    }

    .export-btn {
      width: 100%;
      min-height: 2.5rem;
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border: 1px solid var(--primary);
      border-radius: 4px;
      background: var(--primary);
      color: var(--secondary);
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, opacity 0.15s ease;
    }

    .export-btn:hover:not(:disabled) {
      background: #ff8900;
      border-color: #ff8900;
    }

    .export-btn:active:not(:disabled) {
      background: #e67e00;
      border-color: #e67e00;
    }

    .export-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .export-info-status {
      margin-top: 0.75rem;
      padding: 0.6rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      border: 1px solid var(--theme-a);
      background: rgba(1, 111, 185, 0.08);
    }

    .export-info-status.success {
      border-color: rgba(76, 175, 80, 0.4);
      background: rgba(76, 175, 80, 0.12);
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .export-success-label {
      font-size: 0.7rem;
      color: rgba(76, 175, 80, 0.9);
      margin-bottom: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .export-info-status.success #export-result-link,
    .export-info-status.success #export-result-link:link,
    .export-info-status.success #export-result-link:visited {
      color: rgba(76, 175, 80, 0.95);
      text-decoration: none;
      word-break: break-all;
      overflow-wrap: anywhere;
      display: block;
      line-height: 1.4;
    }

    .export-info-status.success #export-result-link:hover,
    .export-info-status.success #export-result-link:focus {
      color: rgba(76, 175, 80, 1);
      text-decoration: underline;
    }

    .export-info-status.error {
      border-color: rgba(244, 67, 54, 0.4);
      background: rgba(244, 67, 54, 0.12);
      color: #f44336;
    }

    .pattern-save-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--theme-a);
    }

    .pattern-save-section h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .pattern-save-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pattern-name-input {
      flex: 1;
      min-width: 0;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.75rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
    }

    .pattern-name-input::placeholder {
      color: var(--theme-a);
      opacity: 0.6;
    }

    .pattern-name-input:focus {
      outline: none;
      border-color: var(--theme-b);
      box-shadow: 0 0 0 1px var(--theme-b);
    }

    .pattern-save-btn {
      flex-shrink: 0;
      width: 2.25rem;
      height: 2rem;
      padding: 0;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--primary);
      color: var(--secondary);
      border: 1px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pattern-save-btn:hover {
      background: #ff8900;
      border-color: #ff8900;
    }

    .pattern-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pattern-confirm-prompt {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: var(--primary);
    }

    .pattern-confirm-prompt-text {
      font-size: 0.7rem;
      margin-bottom: 0.4rem;
    }

    .pattern-confirm-buttons {
      display: flex;
      gap: 0.35rem;
    }

    .pattern-confirm-btn {
      flex: 1;
      padding: 0.3rem;
      font-family: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .pattern-confirm-btn.yes {
      background: var(--primary);
      color: var(--secondary);
      border-color: var(--primary);
    }

    .pattern-confirm-btn.no {
      background: transparent;
      color: var(--primary);
      border-color: var(--theme-a);
    }

    .pattern-confirm-btn:hover {
      opacity: 0.8;
    }

    .sequencer-scroll-wrapper {
      display: flex;
      flex-direction: column;
      max-height: 420px;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
    }

    .sequencer-grid-scroll {
      overflow: auto;
      flex: 1;
      min-height: 0;
    }

    #sequencer-grid {
      border-left: 1px solid var(--theme-a);
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: fit-content;
    }

    .grid-row {
      display: grid;
      align-items: stretch;
      min-width: fit-content;
    }

    .grid-row-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      padding: 0 0.4rem;
      border-right: 1px solid var(--theme-a);
      border-bottom: 1px solid var(--theme-a);
      background: #050505;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-label-main {
      display: inline-flex;
      align-items: center;
      font-family: inherit;
      font-size: inherit;
      text-transform: lowercase;
      color: var(--primary);
      flex-shrink: 0;
      cursor: pointer;
      background: transparent;
      border: none;
      border-radius: 3px;
    }

    .row-label-main:hover {
      background: rgba(255, 149, 5, 0.15);
      color: var(--primary);
    }

    .row-label-main:active {
      background: rgba(255, 149, 5, 0.25);
    }

    .row-label-sample-wrap {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      min-width: 0;
      flex: 1;
    }

    .row-label-sample {
      color: var(--theme-a);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-label-sample-refresh {
      flex-shrink: 0;
      width: 1.1rem;
      height: 1.1rem;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      cursor: pointer;
      color: var(--theme-a);
      font-size: 0.6rem;
    }

    .row-label-sample-refresh:hover {
      color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .grid-row-label:hover .row-label-sample-refresh {
      display: flex;
    }

    .grid-cell {
      border-right: 1px solid var(--theme-a);
      border-bottom: 1px solid var(--theme-a);
      cursor: pointer;
      background: #050505;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease, box-shadow 0.12s ease;
    }

    .grid-cell:hover {
      background: #111111;
      box-shadow: inset 0 0 0 1px var(--theme-b);
    }

    .grid-cell.active {
      background: var(--primary);
      box-shadow: inset 0 0 0 1px #000000;
    }

    .grid-footer {
      display: grid;
      grid-template-columns: var(--grid-label-width) minmax(0, 1fr);
      border-top: 1px solid var(--theme-a);
      background: #050505;
      flex-shrink: 0;
    }

    .grid-footer-kit,
    .grid-footer-pattern {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      max-width: 280px;
    }

    .grid-footer-pattern {
      border-right: none;
      border-left: 1px solid var(--theme-a);
    }

    .grid-footer input {
      flex: 1;
      min-width: 0;
      padding: 0.4rem 0.5rem;
      font-family: inherit;
      font-size: 0.7rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
    }

    .grid-footer input:focus {
      outline: none;
      border-color: var(--theme-b);
    }

    .grid-footer .save-btn {
      flex-shrink: 0;
      width: 2rem;
      height: 1.75rem;
      padding: 0;
      font-size: 0.8rem;
      background: var(--primary);
      color: var(--secondary);
      border: 1px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .grid-footer .save-btn:hover:not(:disabled) {
      background: #ff8900;
      border-color: #ff8900;
    }

    .grid-footer .save-btn:disabled {
      opacity: 0.7;
      cursor: wait;
    }

    .grid-header {
      display: grid;
      border-top: 1px solid var(--theme-a);
      border-bottom: 1px solid var(--theme-a);
      background: #050505;
      position: sticky;
      top: 0;
      z-index: 5;
      min-width: fit-content;
    }

    .grid-header-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      padding: 0.2rem 0.4rem;
      border-right: 1px solid var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .grid-header-label i {
      font-size: 0.6rem;
    }

    .grid-header-step {
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid var(--theme-a);
      padding: 0.15rem 0;
      color: var(--theme-a);
    }

    .grid-header-step.beat {
      color: var(--theme-b);
    }

    /* Playhead styling (header only) */
    .grid-header-step.playhead {
      background: var(--theme-b);
      color: var(--secondary);
    }

    /* Browser card */
    .browser-card {
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      background: #050505;
      overflow: hidden;
    }

    .browser-card h2 {
      margin: 0;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .browser-card h2 i {
      font-size: 0.75rem;
    }

    .browser-tabs {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0 0.75rem 0.5rem;
      flex-wrap: wrap;
    }

    .browser-tab-btn {
      padding: 0.35rem 0.65rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      background: var(--theme-a);
      color: var(--primary);
      transition: background 0.15s ease, border-color 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .browser-tab-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .browser-tab-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: var(--secondary);
    }

    .browser-tab-divider {
      width: 1px;
      height: 1.25rem;
      background: var(--theme-a);
      flex-shrink: 0;
    }

    .browser-samples-row {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .browser-sample-type-select {
      padding: 0.35rem 0.5rem;
      font-family: inherit;
      font-size: 0.75rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      cursor: pointer;
      min-width: 6rem;
    }

    .browser-sample-type-select:focus {
      outline: none;
      border-color: var(--theme-b);
    }

    .browser-tab-panel {
      padding: 0.75rem;
      border-top: 1px solid var(--theme-a);
    }

    .browser-tab-panel[hidden] {
      display: none;
    }

    .browser-filter-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.75rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }

    .browser-filter-input::placeholder {
      color: var(--theme-a);
      opacity: 0.6;
    }

    .browser-filter-input:focus {
      outline: none;
      border-color: var(--theme-b);
      box-shadow: 0 0 0 1px var(--theme-b);
    }

    .browser-list {
      max-height: 180px;
      overflow-y: auto;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    #browser-kick-list:focus,
    #browser-sample-list:focus {
      outline: none;
    }

    .browser-samples-loading {
      font-size: 0.75rem;
      color: var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding-left: 0.25rem;
    }

    .browser-samples-loading[hidden] {
      display: none !important;
    }

    .browser-list-item {
      font-size: 0.75rem;
      color: var(--primary);
      cursor: pointer;
      outline: 1px solid transparent;
      transition: outline-color 0.15s ease, background 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 1.75rem;
      margin: 2px;
      margin-right: 0.5rem;
      padding-inline: 0.5rem;
      border-radius: 3px;
    }

    .browser-list-item:hover {
      background: rgba(255, 149, 5, 0.12);
    }

    .browser-list-item:active {
      background: rgba(255, 149, 5, 0.22);
    }

    .browser-list-item-name-wrap {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .browser-list-item-name {
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .browser-list-item-path {
      font-size: 0.6rem;
      color: var(--theme-a);
      letter-spacing: 0.02em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .browser-list-item-preview-icon {
      flex-shrink: 0;
      width: 1.2rem;
      color: var(--primary);
      font-size: 0.7rem;
      opacity: 0;
      transition: opacity 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .browser-list-item.previewing .browser-list-item-preview-icon {
      opacity: 1;
    }

    .browser-list-item.selected {
      outline-color: var(--primary);
    }

    .browser-list-item-swap {
      flex-shrink: 0;
      width: 1.2rem;
      min-width: 1.2rem;
      height: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      cursor: pointer;
      color: var(--theme-a);
      font-size: 0.6rem;
    }

    .browser-list-item-swap:hover {
      color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .browser-list-empty {
      font-size: 0.75rem;
      color: var(--theme-a);
      padding: 0.5rem 0;
    }

    .browser-save-section {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--theme-a);
    }

    .browser-save-section h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .browser-name-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.75rem;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }

    .browser-name-input::placeholder {
      color: var(--theme-a);
      opacity: 0.6;
    }

    .browser-name-input:focus {
      outline: none;
      border-color: var(--theme-b);
      box-shadow: 0 0 0 1px var(--theme-b);
    }

    .browser-save-btn {
      width: 100%;
      padding: 0.5rem;
      font-family: inherit;
      font-size: 0.85rem;
      background: var(--primary);
      color: var(--secondary);
      border: 1px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .browser-save-btn:hover {
      background: #ff8900;
      border-color: #ff8900;
    }

    .browser-status-area {
      margin-top: 0.5rem;
      min-height: 2rem;
      font-size: 0.7rem;
    }

    .browser-status-message {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .browser-status-message.success {
      background: rgba(76, 175, 80, 0.15);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .browser-status-message.error {
      background: rgba(244, 67, 54, 0.15);
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }

    .browser-confirm-prompt {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: var(--primary);
    }

    .browser-confirm-prompt-text {
      font-size: 0.7rem;
      margin-bottom: 0.4rem;
    }

    .browser-confirm-buttons {
      display: flex;
      gap: 0.35rem;
    }

    .browser-confirm-btn {
      flex: 1;
      padding: 0.3rem;
      font-family: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .browser-confirm-btn.yes {
      background: var(--primary);
      color: var(--secondary);
      border-color: var(--primary);
    }

    .browser-confirm-btn.no {
      background: transparent;
      color: var(--primary);
      border-color: var(--theme-a);
    }

    .browser-confirm-btn:hover {
      opacity: 0.8;
    }

    .browser-placeholder {
      font-size: 0.75rem;
      color: var(--theme-a);
      padding: 0.5rem 0;
    }

    .browser-kicks-header,
    .browser-samples-header {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .browser-kicks-header .browser-filter-input,
    .browser-samples-header .browser-filter-input {
      flex: 1;
      margin-bottom: 0;
    }

    .browser-refresh-btn {
      padding: 0.5rem 0.65rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      background: var(--theme-a);
      color: var(--primary);
      white-space: nowrap;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .browser-refresh-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    /* Replace sample overlay */
    .replace-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .replace-overlay[hidden] {
      display: none !important;
    }

    .replace-overlay-content {
      background: #050505;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      padding: 1rem;
      min-width: 200px;
    }

    .replace-overlay-title {
      font-size: 0.8rem;
      color: var(--primary);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .replace-overlay-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-bottom: 0.75rem;
    }

    .replace-overlay-row-btn {
      padding: 0.4rem 0.6rem;
      font-family: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      border: 1px solid var(--theme-a);
      border-radius: 3px;
      background: var(--theme-a);
      color: var(--primary);
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .replace-overlay-row-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .replace-overlay-cancel {
      width: 100%;
      padding: 0.4rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid var(--theme-a);
      border-radius: 3px;
      background: transparent;
      color: var(--primary);
    }

    .replace-overlay-cancel:hover {
      background: rgba(255, 149, 5, 0.1);
    }

    /* Confirm modal overlay */
    .confirm-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .confirm-modal-overlay[hidden] {
      display: none !important;
    }

    .confirm-modal-content {
      background: #050505;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      padding: 1rem;
      min-width: 280px;
    }

    .confirm-modal-text {
      font-size: 0.8rem;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .confirm-modal-text i {
      color: var(--theme-c);
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .confirm-modal-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .confirm-modal-btn {
      padding: 0.4rem 0.8rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid var(--theme-a);
      border-radius: 3px;
      background: var(--theme-a);
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .confirm-modal-btn:hover {
      border-color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .confirm-modal-btn.primary {
      background: var(--primary);
      color: var(--secondary);
      border-color: var(--primary);
    }

    .confirm-modal-btn.primary:hover {
      background: #ff8900;
      border-color: #ff8900;
    }

    .error-modal-content .confirm-modal-text i {
      color: var(--theme-c);
    }
  </style>
</head>

<body>
  <header id="toolbar">
    <div class="toolbar-left">
      <a href="/" id="toolbar-brand">‚îå dronmakr v{{ version }} ‚îê</a>
      <nav class="toolbar-nav">
        <a href="/auditionr"><i class="fa-solid fa-wave-square"></i> auditionr</a>
        <a href="/beatbuildr" class="active"><i class="fa-solid fa-drum"></i> beatbuildr</a>
        <a href="/settings"><i class="fa-solid fa-gear"></i> settings</a>
      </nav>
    </div>
    <span id="toolbar-status"><i class="fa-solid fa-spinner fa-spin"></i> connecting‚Ä¶</span>
  </header>

  <main id="app-layout">
    <section id="main-column">
      <div class="sequencer-scroll-wrapper">
        <div class="sequencer-grid-scroll">
          <div id="sequencer-grid"></div>
        </div>
        <div class="grid-footer">
          <div class="grid-footer-kit">
            <input type="text" id="browser-kit-name-input" class="grid-footer-input" placeholder="Enter kit name"
              maxlength="30">
            <button type="button" id="browser-kit-save-btn" class="save-btn" title="Save current drum kit">
              <i class="fa-solid fa-floppy-disk"></i>
            </button>
          </div>
          <div class="grid-footer-pattern">
            <input type="text" id="pattern-name-input" class="grid-footer-input" placeholder="Enter pattern name"
              maxlength="30">
            <button type="button" id="pattern-save-btn" class="save-btn" title="Save current pattern">
              <i class="fa-solid fa-floppy-disk"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="browser-card">
        <h2><i class="fa-solid fa-folder-open"></i> browser</h2>
        <div class="browser-tabs">
          <button type="button" class="browser-tab-btn active" data-tab="patterns" title="Load saved patterns">
            <i class="fa-solid fa-music"></i> patterns
          </button>
          <button type="button" class="browser-tab-btn" data-tab="kits" title="Load saved drum kits">
            <i class="fa-solid fa-drum"></i> kits
          </button>
          <span class="browser-tab-divider"></span>
          <div class="browser-samples-row">
            <button type="button" class="browser-tab-btn" data-tab="samples" title="Browse samples by type">
              <i class="fa-solid fa-headphones"></i> samples
            </button>
            <select id="browser-sample-type-select" class="browser-sample-type-select" title="Sample type">
              <option value="kick">kicks</option>
              <option value="snare">snares</option>
              <option value="hihat">hats</option>
              <option value="clap">claps</option>
              <option value="perc">percs</option>
              <option value="tom">toms</option>
              <option value="shaker">shakers</option>
              <option value="cymbal">cymbals</option>
            </select>
            <div class="browser-samples-loading" id="browser-samples-loading" hidden>
              <i class="fa-solid fa-spinner fa-spin"></i> Loading‚Ä¶
            </div>
          </div>
        </div>
        <div id="browser-tab-patterns" class="browser-tab-panel">
          <input type="text" id="browser-pattern-filter" class="browser-filter-input" placeholder="Filter patterns‚Ä¶">
          <ul id="browser-pattern-list" class="browser-list"></ul>
        </div>
        <div id="browser-tab-kits" class="browser-tab-panel" hidden>
          <input type="text" id="browser-kit-filter" class="browser-filter-input" placeholder="Filter kits‚Ä¶">
          <ul id="browser-kit-list" class="browser-list"></ul>
        </div>
        <div id="browser-tab-samples" class="browser-tab-panel" hidden>
          <div class="browser-samples-header">
            <input type="text" id="browser-sample-filter" class="browser-filter-input" placeholder="Filter‚Ä¶">
            <button type="button" id="browser-sample-refresh-btn" class="browser-refresh-btn"
              title="Rescan sample paths">
              <i class="fa-solid fa-arrow-rotate-right"></i> Refresh
            </button>
          </div>
          <ul id="browser-sample-list" class="browser-list" tabindex="0"></ul>
        </div>
      </div>
      <div id="replace-sample-overlay" class="replace-overlay" hidden>
        <div class="replace-overlay-content">
          <div class="replace-overlay-title">Replace which sample?</div>
          <div id="replace-overlay-buttons" class="replace-overlay-buttons"></div>
          <button type="button" id="replace-overlay-cancel" class="replace-overlay-cancel">Cancel</button>
        </div>
      </div>
      <div id="confirm-modal-overlay" class="confirm-modal-overlay" hidden>
        <div class="confirm-modal-content">
          <div id="confirm-modal-text" class="confirm-modal-text"></div>
          <div class="confirm-modal-buttons">
            <button type="button" id="confirm-modal-yes" class="confirm-modal-btn primary"><i
                class="fa-solid fa-check"></i> Yes</button>
            <button type="button" id="confirm-modal-no" class="confirm-modal-btn"><i class="fa-solid fa-xmark"></i>
              No</button>
          </div>
        </div>
      </div>
      <div id="error-modal-overlay" class="confirm-modal-overlay" hidden>
        <div class="confirm-modal-content error-modal-content">
          <div id="error-modal-text" class="confirm-modal-text"></div>
          <div class="confirm-modal-buttons">
            <button type="button" id="error-modal-close" class="confirm-modal-btn primary"><i
                class="fa-solid fa-xmark"></i> Close</button>
          </div>
        </div>
      </div>
    </section>

    <aside id="sidebar-column">
      <h2><i class="fa-solid fa-sliders"></i> Controls</h2>
      <div id="transport">
        <div class="transport-actions">
          <button type="button" id="new-pattern-btn" class="transport-btn transport-btn-secondary"
            title="Start new pattern (reset all, load random kit)">
            <i class="fa-solid fa-plus"></i>
          </button>
          <button type="button" id="undo-btn" class="transport-btn transport-btn-secondary" title="Undo last edit"
            disabled>
            <i class="fa-solid fa-undo"></i>
          </button>
          <button type="button" id="redo-btn" class="transport-btn transport-btn-secondary" title="Redo" disabled>
            <i class="fa-solid fa-redo"></i>
          </button>
          <button type="button" id="play-toggle" class="transport-btn transport-btn-primary" title="Play">
            <i class="fa-solid fa-play"></i>
          </button>
          <button type="button" id="stop-button" class="transport-btn transport-btn-secondary" title="Stop">
            <i class="fa-solid fa-stop"></i>
          </button>
          <button type="button" id="new-kit-btn" class="transport-btn transport-btn-secondary"
            title="Load new random drum kit">
            <i class="fa-solid fa-dice-five"></i>
          </button>
          <button type="button" id="clear-sequencer-btn" class="transport-btn transport-btn-secondary"
            title="Clear entire sequencer">
            <i class="fa-solid fa-eraser"></i>
          </button>
        </div>
        <div class="sidebar-section-divider"></div>
        <h3 class="sidebar-section-label"><i class="fa-solid fa-music"></i> Pattern Settings</h3>
        <div class="transport-tempo">
          <label for="tempo-input">Tempo (bpm)</label>
          <input type="number" id="tempo-input" min="40" max="240" value="120" title="Beats per minute">
        </div>
        <div class="transport-swing">
          <label for="swing-input">
            <span>Swing</span>
            <span class="swing-value" id="swing-display">0%</span>
          </label>
          <div class="swing-slider-wrapper">
            <div class="swing-fake-track"></div>
            <input type="range" id="swing-input" min="0" max="100" value="0" step="1"
              title="Swing amount (0 = straight, 100 = triplet feel)">
          </div>
        </div>
        <div class="transport-setting transport-grid-size">
          <label for="grid-size-select">Grid size</label>
          <select id="grid-size-select" title="Note grid resolution">
            <option value="1/16">1/16</option>
            <option value="1/16t">1/16 triplet</option>
          </select>
        </div>
        <div class="transport-setting transport-time-signature">
          <label for="time-signature-select">Time signature</label>
          <select id="time-signature-select" title="Beats per bar">
            <option value="4/4">4/4</option>
            <option value="3/4">3/4</option>
          </select>
        </div>
        <div class="transport-setting transport-pattern-length">
          <label for="pattern-length-input">Pattern length (bars)</label>
          <input type="number" id="pattern-length-input" min="1" max="16" value="1" title="Number of bars">
        </div>
        <div class="sidebar-section-divider"></div>
        <h3 class="sidebar-section-label"><i class="fa-solid fa-file-export"></i> Export</h3>
        <div class="transport-setting transport-export">
          <label for="export-loops-input">Loops</label>
          <input type="number" id="export-loops-input" min="1" max="64" value="1" title="Number of times to repeat the pattern on export">
        </div>
        <div class="transport-export-actions">
          <button type="button" id="export-btn" class="export-btn" title="Export as WAV">
            <i class="fa-solid fa-download"></i> Export WAV
          </button>
        </div>
        <div id="export-status" class="export-info-status" hidden>
          <span class="export-success-label" id="export-success-label">Export successful</span>
          <a id="export-result-link" href="#" target="_blank" rel="noopener"></a>
          <span id="export-error"></span>
        </div>
      </div>
    </aside>
  </main>

  <script>
    const ROWS = ["kick", "snar", "ghos", "clap", "hhat", "halt", "shkr", "prca", "prcb", "prcc", "tomm", "cymb"];
    const BPM_MIN = 40;
    const BPM_MAX = 240;
    const GRID_STEPS_PER_BEAT = { "1/16": 4, "1/16t": 6 };
    const TIME_SIG_BEATS = { "4/4": 4, "3/4": 3 };

    function getSteps() {
      const spb = GRID_STEPS_PER_BEAT[state.gridSize] || 4;
      const bpb = TIME_SIG_BEATS[state.timeSignature] || 4;
      return spb * bpb * state.patternLength;
    }

    const state = {
      kit: null,
      pattern: {}, // { rowKey: [0/1,...] }
      buffers: {}, // { rowKey: AudioBuffer | null }
      bpm: 120,
      swing: 0, // 0.0 to 1.0 (0 = straight, 1 = triplet feel)
      gridSize: "1/16",
      timeSignature: "4/4",
      patternLength: 1,
      undoState: null,  // { type: 'pattern', data } | { type: 'kit', data: { row, path, name, url } }
      redoState: null,
    };

    const dragState = {
      active: false,
      flippedKeys: null, // Set of "rowKey-step"
    };

    const toolbarStatusEl = document.getElementById("toolbar-status");
    const gridContainer = document.getElementById("sequencer-grid");
    const playToggleBtn = document.getElementById("play-toggle");
    const stopButton = document.getElementById("stop-button");
    const tempoInput = document.getElementById("tempo-input");
    const swingInput = document.getElementById("swing-input");
    const swingDisplay = document.getElementById("swing-display");
    const undoBtn = document.getElementById("undo-btn");
    const redoBtn = document.getElementById("redo-btn");

    function getStepDurationSec() {
      const spb = GRID_STEPS_PER_BEAT[state.gridSize] || 4;
      return 60 / state.bpm / spb;
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isPlaying = false;
    let currentStep = 0;
    let playIntervalId = null;

    function initEmptyPattern() {
      const steps = getSteps();
      ROWS.forEach(row => {
        state.pattern[row] = new Array(steps).fill(0);
        state.buffers[row] = null;
      });
      state.undoState = null;
      state.redoState = null;
    }

    function deepCopyPattern() {
      const copy = {};
      ROWS.forEach(row => {
        copy[row] = state.pattern[row].slice();
      });
      return copy;
    }

    function saveUndoState() {
      state.redoState = null;
      state.undoState = { type: "pattern", data: deepCopyPattern() };
      updateUndoRedoButtons();
    }

    function saveKitUndoState(row, previousDescriptor) {
      if (!previousDescriptor || !previousDescriptor.path) return;
      state.redoState = null;
      state.undoState = { type: "kit", data: { row, ...previousDescriptor } };
      updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
      undoBtn.disabled = state.undoState === null;
      redoBtn.disabled = state.redoState === null;
    }

    function undo() {
      if (state.undoState === null) return;
      const u = state.undoState;
      if (u.type === "pattern") {
        state.redoState = { type: "pattern", data: deepCopyPattern() };
        ROWS.forEach(row => {
          state.pattern[row] = u.data[row].slice();
        });
      } else if (u.type === "kit" && u.data && u.data.path) {
        state.redoState = { type: "kit", data: getCurrentKitDescriptorForRow(u.data.row) };
        if (state.socket && state.socket.connected) {
          state.socket.emit("replaceSampleWithPath", { row: u.data.row, path: u.data.path });
        }
      }
      state.undoState = null;
      updateUndoRedoButtons();
      renderGrid();
    }

    function redo() {
      if (state.redoState === null) return;
      const r = state.redoState;
      if (r.type === "pattern") {
        state.undoState = { type: "pattern", data: deepCopyPattern() };
        ROWS.forEach(row => {
          state.pattern[row] = r.data[row].slice();
        });
      } else if (r.type === "kit" && r.data && r.data.path) {
        state.undoState = { type: "kit", data: getCurrentKitDescriptorForRow(r.data.row) };
        if (state.socket && state.socket.connected) {
          state.socket.emit("replaceSampleWithPath", { row: r.data.row, path: r.data.path });
        }
      }
      state.redoState = null;
      updateUndoRedoButtons();
      renderGrid();
    }

    function getCurrentKitDescriptorForRow(row) {
      const desc = state.kit && state.kit.kit && state.kit.kit[row];
      return desc && desc.path ? { row, path: desc.path, name: desc.name, url: desc.url } : null;
    }

    function renderGrid() {
      gridContainer.innerHTML = "";

      const steps = getSteps();
      const gridCols = `var(--grid-label-width) repeat(${steps}, var(--grid-cell-size))`;

      const header = document.createElement("div");
      header.className = "grid-header";
      header.style.gridTemplateColumns = gridCols;

      const headerLabel = document.createElement("div");
      headerLabel.className = "grid-header-label";
      headerLabel.innerHTML = "<i class=\"fa-solid fa-table-cells\"></i> sample";
      header.appendChild(headerLabel);

      const spb = GRID_STEPS_PER_BEAT[state.gridSize] || 4;
      for (let step = 0; step < steps; step++) {
        const stepEl = document.createElement("div");
        stepEl.className = "grid-header-step";
        const isBeat = step % spb === 0;
        if (isBeat) {
          stepEl.classList.add("beat");
        }
        stepEl.textContent = step + 1;
        header.appendChild(stepEl);
      }

      gridContainer.appendChild(header);

      ROWS.forEach((rowKey) => {
        const rowWrapper = document.createElement("div");
        rowWrapper.className = "grid-row";
        rowWrapper.style.gridTemplateColumns = gridCols;

        const rowLabel = document.createElement("div");
        rowLabel.className = "grid-row-label";

        const mainLabel = document.createElement("button");
        mainLabel.type = "button";
        mainLabel.className = "row-label-main";
        mainLabel.textContent = rowKey;
        mainLabel.title = "Preview sample";
        mainLabel.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          playPreview(rowKey);
        });
        rowLabel.appendChild(mainLabel);

        const sampleWrap = document.createElement("div");
        sampleWrap.className = "row-label-sample-wrap";

        const sampleLabel = document.createElement("span");
        sampleLabel.className = "row-label-sample";
        const sampleDescriptor = state.kit && state.kit.kit && state.kit.kit[rowKey];
        const sampleName = sampleDescriptor && sampleDescriptor.name
          ? sampleDescriptor.name
          : "no sample";
        sampleLabel.textContent = sampleName;
        sampleLabel.title = sampleName;
        sampleWrap.appendChild(sampleLabel);

        const refreshBtn = document.createElement("span");
        refreshBtn.className = "row-label-sample-refresh";
        refreshBtn.title = "Replace with another random sample";
        refreshBtn.setAttribute("aria-label", "Replace sample");
        refreshBtn.innerHTML = "<i class=\"fa-solid fa-arrow-rotate-right\"></i>";
        refreshBtn.dataset.row = rowKey;
        refreshBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (state.socket && state.socket.connected) {
            state.socket.emit("replaceSample", { row: rowKey });
          }
        });
        sampleWrap.appendChild(refreshBtn);

        rowLabel.appendChild(sampleWrap);
        rowWrapper.appendChild(rowLabel);

        for (let step = 0; step < steps; step++) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          const val = state.pattern[rowKey] && state.pattern[rowKey][step];
          if (val === 1) {
            cell.classList.add("active");
          }

          cell.dataset.row = rowKey;
          cell.dataset.step = step.toString();

          rowWrapper.appendChild(cell);
        }

        gridContainer.appendChild(rowWrapper);
      });
    }

    function flipCell(rowKey, stepIndex) {
      const current = state.pattern[rowKey][stepIndex];
      const next = current === 1 ? 0 : 1;
      state.pattern[rowKey][stepIndex] = next;
      const cell = gridContainer.querySelector(`.grid-cell[data-row="${rowKey}"][data-step="${stepIndex}"]`);
      if (cell) {
        if (next === 1) {
          cell.classList.add("active");
        } else {
          cell.classList.remove("active");
        }
      }
    }

    function setupGridDrag() {
      gridContainer.addEventListener("mousedown", (e) => {
        const cell = e.target.closest(".grid-cell");
        if (!cell) return;
        e.preventDefault();
        const rowKey = cell.dataset.row;
        const stepIndex = parseInt(cell.dataset.step, 10);
        saveUndoState();
        dragState.active = true;
        dragState.flippedKeys = new Set();
        const key = `${rowKey}-${stepIndex}`;
        dragState.flippedKeys.add(key);
        flipCell(rowKey, stepIndex);
      });
    }

    document.addEventListener("mousemove", (e) => {
      if (!dragState.active) return;
      const cell = e.target.closest(".grid-cell");
      if (!cell) return;
      const rowKey = cell.dataset.row;
      const stepIndex = parseInt(cell.dataset.step, 10);
      const key = `${rowKey}-${stepIndex}`;
      if (dragState.flippedKeys.has(key)) return;
      dragState.flippedKeys.add(key);
      flipCell(rowKey, stepIndex);
    });

    document.addEventListener("mouseup", () => {
      dragState.active = false;
      dragState.flippedKeys = null;
    });

    initEmptyPattern();
    renderGrid();
    updateUndoRedoButtons();

    setupGridDrag();

    const socket = io();
    state.socket = socket;

    socket.on("connect", () => {
      toolbarStatusEl.innerHTML = "<i class=\"fa-solid fa-link\"></i> connected";
    });

    socket.on("disconnect", () => {
      toolbarStatusEl.innerHTML = "<i class=\"fa-solid fa-unlink\"></i> disconnected";
    });

    async function loadBufferForRow(rowKey, url) {
      try {
        const res = await fetch(url);
        const arrayBuffer = await res.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        state.buffers[rowKey] = audioBuffer;
      } catch (e) {
        console.error("Failed to load sample for", rowKey, e);
        state.buffers[rowKey] = null;
      }
    }

    async function hydrateKitBuffers(kit) {
      if (!kit || !kit.kit) return;
      const tasks = [];
      ROWS.forEach((rowKey) => {
        const desc = kit.kit[rowKey];
        if (desc && desc.url) {
          tasks.push(loadBufferForRow(rowKey, desc.url));
        } else {
          state.buffers[rowKey] = null;
        }
      });
      await Promise.all(tasks);
    }

    socket.on("kit", async (data) => {
      state.kit = data;
      state.undoState = null;
      state.redoState = null;
      updateUndoRedoButtons();
      await hydrateKitBuffers(data);
      renderGrid();
      console.log("Received drum kit:", data);
    });

    socket.on("sampleReplaced", async (data) => {
      if (!data || !data.row || !state.kit || !state.kit.kit) return;
      const rowKey = data.row;
      state.kit.kit[rowKey] = { name: data.name, path: data.path, url: data.url };
      await loadBufferForRow(rowKey, data.url);
      renderGrid();
    });

    document.getElementById("new-kit-btn").addEventListener("click", () => {
      if (state.socket && state.socket.connected) state.socket.emit("requestNewKit");
    });

    document.getElementById("new-pattern-btn").addEventListener("click", () => {
      showConfirmModal("Start new pattern? This will reset all settings, clear the sequencer, and load a random kit.", () => {
        state.bpm = 120;
        state.swing = 0;
        state.gridSize = "1/16";
        state.timeSignature = "4/4";
        state.patternLength = 1;
        tempoInput.value = state.bpm;
        swingInput.value = 0;
        swingDisplay.textContent = "0%";
        gridSizeSelect.value = state.gridSize;
        timeSignatureSelect.value = state.timeSignature;
        patternLengthInput.value = state.patternLength;
        patternNameInput.value = "";
        browserKitNameInput.value = "";
        initEmptyPattern();
        if (state.socket && state.socket.connected) state.socket.emit("requestNewKit");
        renderGrid();
        updateUndoRedoButtons();
      });
    });

    document.getElementById("clear-sequencer-btn").addEventListener("click", () => {
      initEmptyPattern();
      renderGrid();
    });

    function clearPlayhead() {
      document.querySelectorAll(".grid-header-step.playhead").forEach(el => el.classList.remove("playhead"));
    }

    function updatePlayhead(stepIndex) {
      clearPlayhead();

      const headerSteps = document.querySelectorAll(".grid-header-step");
      headerSteps.forEach((el, idx) => {
        if (idx === stepIndex) {
          el.classList.add("playhead");
        }
      });
    }

    function playPreview(rowKey) {
      const buffer = state.buffers[rowKey];
      if (!buffer) return;
      if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start(0);
    }

    function getSwingOffsetForStep(stepIndex) {
      if (state.swing <= 0) return 0;
      const spb = GRID_STEPS_PER_BEAT[state.gridSize] || 4;
      const posInBeat = stepIndex % spb;
      const offBeatStep = Math.floor(spb / 2);
      if (posInBeat === offBeatStep) {
        const beatDurationSec = 60 / state.bpm;
        const swingTripletOffsetSec = beatDurationSec / 6.0;
        return state.swing * swingTripletOffsetSec;
      }
      return 0;
    }

    function scheduleStep(stepIndex) {
      const baseTime = audioCtx.currentTime + 0.05; // small lookahead
      const swingOffset = getSwingOffsetForStep(stepIndex);
      const when = baseTime + swingOffset;

      ROWS.forEach(rowKey => {
        const patternRow = state.pattern[rowKey];
        const buffer = state.buffers[rowKey];
        if (!patternRow || !buffer) return;
        if (patternRow[stepIndex] !== 1) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(when);
      });
    }

    function advanceStep() {
      updatePlayhead(currentStep);
      scheduleStep(currentStep);
      currentStep = (currentStep + 1) % getSteps();
    }

    async function startPlayback() {
      if (isPlaying) return;
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      isPlaying = true;
      currentStep = 0;
      playToggleBtn.innerHTML = "<i class=\"fa-solid fa-pause\"></i>";
      playToggleBtn.title = "Pause";

      advanceStep();
      playIntervalId = setInterval(advanceStep, getStepDurationSec() * 1000);
    }

    function restartPlaybackInterval() {
      if (!isPlaying || playIntervalId === null) return;
      clearInterval(playIntervalId);
      playIntervalId = setInterval(advanceStep, getStepDurationSec() * 1000);
    }

    function stopPlayback() {
      if (!isPlaying) {
        clearPlayhead();
        currentStep = 0;
        return;
      }
      isPlaying = false;
      playToggleBtn.innerHTML = "<i class=\"fa-solid fa-play\"></i>";
      playToggleBtn.title = "Play";
      if (playIntervalId !== null) {
        clearInterval(playIntervalId);
        playIntervalId = null;
      }
      clearPlayhead();
      currentStep = 0;
    }

    playToggleBtn.addEventListener("click", () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        startPlayback();
      }
    });

    stopButton.addEventListener("click", () => {
      stopPlayback();
    });

    tempoInput.addEventListener("change", () => {
      let val = parseInt(tempoInput.value, 10);
      if (Number.isNaN(val)) val = state.bpm;
      state.bpm = Math.max(BPM_MIN, Math.min(BPM_MAX, val));
      tempoInput.value = state.bpm;
      if (isPlaying) restartPlaybackInterval();
    });

    tempoInput.addEventListener("input", () => {
      let val = parseInt(tempoInput.value, 10);
      if (!Number.isNaN(val)) {
        state.bpm = Math.max(BPM_MIN, Math.min(BPM_MAX, val));
        if (isPlaying) restartPlaybackInterval();
      }
    });

    swingInput.addEventListener("input", () => {
      const val = parseInt(swingInput.value, 10);
      state.swing = val / 100; // Convert 0-100 to 0.0-1.0
      swingDisplay.textContent = `${val}%`;
    });

    function resizePatternToConfig() {
      const steps = getSteps();
      ROWS.forEach(rowKey => {
        const current = state.pattern[rowKey] || [];
        const next = new Array(steps).fill(0);
        const copyLen = Math.min(current.length, steps);
        for (let i = 0; i < copyLen; i++) next[i] = current[i];
        state.pattern[rowKey] = next;
      });
      renderGrid();
      if (isPlaying) restartPlaybackInterval();
    }

    const gridSizeSelect = document.getElementById("grid-size-select");
    const timeSignatureSelect = document.getElementById("time-signature-select");
    const patternLengthInput = document.getElementById("pattern-length-input");

    gridSizeSelect.addEventListener("change", () => {
      state.gridSize = gridSizeSelect.value;
      resizePatternToConfig();
    });
    timeSignatureSelect.addEventListener("change", () => {
      state.timeSignature = timeSignatureSelect.value;
      resizePatternToConfig();
    });
    patternLengthInput.addEventListener("change", () => {
      let val = parseInt(patternLengthInput.value, 10);
      if (Number.isNaN(val) || val < 1) val = 1;
      val = Math.min(16, val);
      state.patternLength = val;
      patternLengthInput.value = state.patternLength;
      resizePatternToConfig();
    });

    undoBtn.addEventListener("click", undo);
    redoBtn.addEventListener("click", redo);

    // Export
    const exportLoopsInput = document.getElementById("export-loops-input");
    const exportBtn = document.getElementById("export-btn");
    const exportStatusEl = document.getElementById("export-status");
    const exportResultLink = document.getElementById("export-result-link");
    const exportErrorEl = document.getElementById("export-error");

    function isPatternEmpty() {
      return ROWS.every((row) => {
        const arr = state.pattern[row] || [];
        return !arr.some((v) => v === 1);
      });
    }

    exportBtn.addEventListener("click", () => {
      if (!state.socket || !state.socket.connected) return;
      const kit = encodeKitForSave ? encodeKitForSave() : null;
      if (!kit) {
        showErrorModal("No drum kit loaded. Load or generate a kit first.");
        return;
      }
      if (isPatternEmpty()) {
        showErrorModal("Sequencer is empty. Add at least one step before exporting.");
        return;
      }
      const pattern = encodePatternForSave();
      const loops = Math.max(1, parseInt(exportLoopsInput.value, 10) || 1);
      exportLoopsInput.value = String(loops);
      exportStatusEl.hidden = true;
      exportStatusEl.classList.remove("success", "error");
      const exportSuccessLabel = document.getElementById("export-success-label");
      if (exportSuccessLabel) exportSuccessLabel.hidden = true;
      exportResultLink.href = "#";
      exportResultLink.textContent = "";
      exportResultLink.hidden = true;
      exportErrorEl.textContent = "";
      exportErrorEl.hidden = true;
      exportBtn.disabled = true;
      exportBtn.querySelector("i").className = "fa-solid fa-spinner fa-spin";
      state.socket.emit("exportBeat", {
        bpm: state.bpm,
        swing: state.swing,
        gridSize: state.gridSize,
        timeSignature: state.timeSignature.split("/").map(Number),
        length: state.patternLength,
        loops,
        humanize: true,
        pattern,
        kit,
        patternName: (document.getElementById("pattern-name-input")?.value || "").trim(),
        kitName: (document.getElementById("browser-kit-name-input")?.value || "").trim(),
      });
    });

    socket.on("exportBeatResult", (data) => {
      exportBtn.disabled = false;
      exportBtn.querySelector("i").className = "fa-solid fa-download";
      exportStatusEl.hidden = false;
      if (data.success && data.filename) {
        exportStatusEl.classList.remove("error");
        exportStatusEl.classList.add("success");
        const exportSuccessLabel = document.getElementById("export-success-label");
        if (exportSuccessLabel) exportSuccessLabel.hidden = false;
        exportResultLink.href = "/exports/" + data.filename;
        exportResultLink.textContent = data.filename;
        exportResultLink.hidden = false;
        exportErrorEl.textContent = "";
        exportErrorEl.hidden = true;
      } else if (data.error) {
        exportStatusEl.classList.remove("success");
        exportStatusEl.classList.add("error");
        const exportSuccessLabel = document.getElementById("export-success-label");
        if (exportSuccessLabel) exportSuccessLabel.hidden = true;
        exportResultLink.hidden = true;
        exportErrorEl.textContent = data.error;
        exportErrorEl.hidden = false;
      }
    });

    // Pattern save functionality
    const patternNameInput = document.getElementById("pattern-name-input");
    const patternSaveBtn = document.getElementById("pattern-save-btn");
    const errorModalOverlay = document.getElementById("error-modal-overlay");
    const errorModalText = document.getElementById("error-modal-text");
    const errorModalClose = document.getElementById("error-modal-close");

    function encodePatternForSave() {
      const [num, den] = state.timeSignature.split("/").map(Number);
      const encoded = {
        _meta: {
          gridSize: state.gridSize,
          timeSignature: [num || 4, den || 4],
          length: state.patternLength,
          tempo: state.bpm,
          swing: state.swing,
        },
      };
      ROWS.forEach(rowKey => {
        encoded[rowKey] = state.pattern[rowKey] ? state.pattern[rowKey].slice() : [];
      });
      return encoded;
    }

    const confirmModalOverlay = document.getElementById("confirm-modal-overlay");
    const confirmModalText = document.getElementById("confirm-modal-text");
    const confirmModalYes = document.getElementById("confirm-modal-yes");
    const confirmModalNo = document.getElementById("confirm-modal-no");

    function showErrorModal(message) {
      errorModalText.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i><span>${message}</span>`;
      errorModalOverlay.hidden = false;
      errorModalClose.onclick = () => {
        errorModalOverlay.hidden = true;
        errorModalClose.onclick = null;
      };
    }

    function showConfirmModal(message, onYes, onNo) {
      confirmModalText.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i><span>${message}</span>`;
      confirmModalOverlay.hidden = false;
      const hide = () => { confirmModalOverlay.hidden = true; };
      confirmModalYes.onclick = () => { hide(); onYes && onYes(); confirmModalYes.onclick = null; confirmModalNo.onclick = null; };
      confirmModalNo.onclick = () => { hide(); onNo && onNo(); confirmModalYes.onclick = null; confirmModalNo.onclick = null; };
    }

    function showConfirmPrompt(patternName) {
      showConfirmModal(`Are you sure you want to overwrite "${patternName}"?`, () => {
        const pattern = encodePatternForSave();
        if (state.socket && state.socket.connected) {
          setPatternSaveBtnState("loading");
          state.socket.emit("savePattern", { name: patternName, pattern, overwrite: true });
        }
      });
    }

    function setPatternSaveBtnState(btnState) {
      const icon = patternSaveBtn.querySelector("i");
      patternSaveBtn.disabled = btnState === "loading";
      icon.className = btnState === "loading" ? "fa-solid fa-spinner fa-spin" : btnState === "success" ? "fa-solid fa-check" : "fa-solid fa-floppy-disk";
      if (btnState === "success") {
        setTimeout(() => {
          patternSaveBtn.querySelector("i").className = "fa-solid fa-floppy-disk";
        }, 1500);
      }
    }

    patternSaveBtn.addEventListener("click", () => {
      const patternName = patternNameInput.value.trim();
      if (!patternName) {
        showErrorModal("Please enter a pattern name.");
        return;
      }

      const pattern = encodePatternForSave();
      if (state.socket && state.socket.connected) {
        setPatternSaveBtnState("loading");
        state.socket.emit("savePattern", { name: patternName, pattern, overwrite: false });
      }
    });

    socket.on("patternSaveResult", (data) => {
      if (data.needsConfirmation) {
        setPatternSaveBtnState("idle");
        showConfirmPrompt(data.name);
      } else if (data.success) {
        setPatternSaveBtnState("success");
        state.socket && state.socket.emit("getPatterns");
      } else if (data.error) {
        setPatternSaveBtnState("idle");
        showErrorModal(data.error);
      }
    });

    // Browser card ‚Äì tab switching
    const SAMPLE_TYPES = ["kick", "snare", "hihat", "clap", "perc", "tom", "shaker", "cymbal"];
    const SAMPLE_TYPE_LABELS = { kick: "kicks", snare: "snares", hihat: "hats", clap: "claps", perc: "percs", tom: "toms", shaker: "shakers", cymbal: "cymbals" };
    const browserTabBtns = document.querySelectorAll(".browser-tab-btn[data-tab]");
    const browserTabPatterns = document.getElementById("browser-tab-patterns");
    const browserTabKits = document.getElementById("browser-tab-kits");
    const browserTabSamples = document.getElementById("browser-tab-samples");
    const browserSampleTypeSelect = document.getElementById("browser-sample-type-select");

    browserTabBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        browserTabBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        browserTabPatterns.hidden = tab !== "patterns";
        browserTabKits.hidden = tab !== "kits";
        browserTabSamples.hidden = tab !== "samples";
        if (tab === "patterns") {
          state.socket && state.socket.emit("getPatterns");
        } else if (tab === "kits") {
          state.socket && state.socket.emit("getDrumKits");
        } else if (tab === "samples") {
          currentSampleType = browserSampleTypeSelect.value;
          requestSamplesForType(currentSampleType);
        }
      });
    });

    browserSampleTypeSelect.addEventListener("change", () => {
      currentSampleType = browserSampleTypeSelect.value;
      if (!browserTabSamples.hidden) {
        requestSamplesForType(currentSampleType);
      }
    });

    // Browser ‚Äì patterns list, filter, load
    const browserPatternFilter = document.getElementById("browser-pattern-filter");
    const browserPatternList = document.getElementById("browser-pattern-list");

    let patternList = [];

    function renderPatternList() {
      const query = (browserPatternFilter.value || "").trim().toLowerCase();
      const filtered = query
        ? patternList.filter((name) => name.toLowerCase().includes(query))
        : patternList;

      browserPatternList.innerHTML = "";
      if (filtered.length === 0) {
        const li = document.createElement("li");
        li.className = "browser-list-empty";
        li.textContent = patternList.length === 0 ? "No patterns saved yet" : "No matching patterns";
        browserPatternList.appendChild(li);
        return;
      }

      filtered.forEach((patternName) => {
        const li = document.createElement("li");
        li.className = "browser-list-item";
        li.innerHTML = "<i class=\"fa-solid fa-music\"></i> " + patternName;
        li.dataset.patternName = patternName;
        li.addEventListener("click", () => {
          patternNameInput.value = patternName;
          if (state.socket && state.socket.connected) {
            state.socket.emit("loadPattern", { name: patternName });
          }
        });
        browserPatternList.appendChild(li);
      });
    }

    browserPatternFilter.addEventListener("input", renderPatternList);

    socket.on("patterns", (data) => {
      patternList = (data && data.patterns) ? [...data.patterns] : [];
      renderPatternList();
    });

    function applyLoadedPattern(data) {
      if (!data || !data.pattern) return;
      const pattern = data.pattern;
      const meta = (pattern._meta && typeof pattern._meta === "object") ? pattern._meta : {};

      state.gridSize = (meta.gridSize === "1/16" || meta.gridSize === "1/16t") ? meta.gridSize : "1/16";
      gridSizeSelect.value = state.gridSize;

      const ts = (meta.timeSignature && Array.isArray(meta.timeSignature) && meta.timeSignature.length >= 2)
        ? `${meta.timeSignature[0]}/${meta.timeSignature[1]}`
        : "4/4";
      state.timeSignature = ["4/4", "3/4"].includes(ts) ? ts : "4/4";
      timeSignatureSelect.value = state.timeSignature;

      state.patternLength = (typeof meta.length === "number" && meta.length >= 1 && meta.length <= 16)
        ? Math.round(meta.length) : 1;
      patternLengthInput.value = state.patternLength;

      state.bpm = (typeof meta.tempo === "number" && meta.tempo >= 40 && meta.tempo <= 240)
        ? Math.round(meta.tempo) : 120;
      tempoInput.value = state.bpm;

      state.swing = (typeof meta.swing === "number" && meta.swing >= 0 && meta.swing <= 1)
        ? meta.swing : 0;
      swingInput.value = Math.round(state.swing * 100);
      swingDisplay.textContent = Math.round(state.swing * 100) + "%";

      if (data.name) patternNameInput.value = data.name;

      ROWS.forEach((rowKey) => {
        const rowData = pattern[rowKey];
        if (Array.isArray(rowData)) {
          state.pattern[rowKey] = rowData.slice();
        }
      });

      resizePatternToConfig();
    }

    socket.on("patternLoaded", (data) => {
      applyLoadedPattern(data);
    });

    socket.on("patternLoadResult", (data) => {
      if (data.error) {
        showErrorModal(data.error);
      }
    });

    // Browser ‚Äì kits list, filter, load, save
    const browserKitFilter = document.getElementById("browser-kit-filter");
    const browserKitList = document.getElementById("browser-kit-list");
    const browserKitNameInput = document.getElementById("browser-kit-name-input");
    const browserKitSaveBtn = document.getElementById("browser-kit-save-btn");

    let drumKitsList = [];

    function renderKitList() {
      const query = (browserKitFilter.value || "").trim().toLowerCase();
      const filtered = query
        ? drumKitsList.filter((name) => name.toLowerCase().includes(query))
        : drumKitsList;

      browserKitList.innerHTML = "";
      if (filtered.length === 0) {
        const li = document.createElement("li");
        li.className = "browser-list-empty";
        li.textContent = drumKitsList.length === 0 ? "No kits saved yet" : "No matching kits";
        browserKitList.appendChild(li);
        return;
      }

      filtered.forEach((kitName) => {
        const li = document.createElement("li");
        li.className = "browser-list-item";
        li.innerHTML = "<i class=\"fa-solid fa-drum\"></i> " + kitName;
        li.dataset.kitName = kitName;
        li.addEventListener("click", () => {
          browserKitNameInput.value = kitName;
          if (state.socket && state.socket.connected) {
            state.socket.emit("loadKit", { name: kitName });
          }
        });
        browserKitList.appendChild(li);
      });
    }

    browserKitFilter.addEventListener("input", renderKitList);

    socket.on("drumKits", (data) => {
      drumKitsList = (data && data.kits) ? [...data.kits] : [];
      renderKitList();
    });

    // Request patterns when page loads (patterns tab is default visible)
    if (socket.connected) socket.emit("getPatterns");
    socket.on("connect", () => {
      socket.emit("getPatterns");
    });

    function encodeKitForSave() {
      if (!state.kit || !state.kit.kit) return null;
      const kit = state.kit.kit;
      const encoded = {};
      ROWS.forEach((rowKey) => {
        const desc = kit[rowKey];
        if (desc && desc.path) {
          encoded[rowKey] = { path: desc.path, name: desc.name };
        }
      });
      return Object.keys(encoded).length > 0 ? encoded : null;
    }

    function setKitSaveBtnState(btnState) {
      const icon = browserKitSaveBtn.querySelector("i");
      browserKitSaveBtn.disabled = btnState === "loading";
      icon.className = btnState === "loading" ? "fa-solid fa-spinner fa-spin" : btnState === "success" ? "fa-solid fa-check" : "fa-solid fa-floppy-disk";
      if (btnState === "success") {
        setTimeout(() => {
          browserKitSaveBtn.querySelector("i").className = "fa-solid fa-floppy-disk";
        }, 1500);
      }
    }

    function showKitConfirmPrompt(kitName) {
      showConfirmModal(`Are you sure you want to overwrite "${kitName}"?`, () => {
        const kit = encodeKitForSave();
        if (kit && state.socket && state.socket.connected) {
          setKitSaveBtnState("loading");
          state.socket.emit("saveKit", { name: kitName, kit, overwrite: true });
        }
      });
    }

    browserKitSaveBtn.addEventListener("click", () => {
      const kitName = browserKitNameInput.value.trim();
      if (!kitName) {
        showErrorModal("Please enter a kit name.");
        return;
      }
      const kit = encodeKitForSave();
      if (!kit) {
        showErrorModal("No kit to save. Load or generate a kit first.");
        return;
      }
      if (state.socket && state.socket.connected) {
        setKitSaveBtnState("loading");
        state.socket.emit("saveKit", { name: kitName, kit, overwrite: false });
      }
    });

    socket.on("kitSaveResult", (data) => {
      if (data.needsConfirmation) {
        setKitSaveBtnState("idle");
        showKitConfirmPrompt(data.name);
      } else if (data.success) {
        setKitSaveBtnState("success");
      } else if (data.error) {
        setKitSaveBtnState("idle");
        showErrorModal(data.error);
      }
    });

    socket.on("kitLoadResult", (data) => {
      if (data.error) {
        showErrorModal(data.error);
      }
    });

    // Sample browser (kicks, snares, etc.)
    let currentSampleType = "kick";
    const browserSampleFilter = document.getElementById("browser-sample-filter");
    const browserSampleList = document.getElementById("browser-sample-list");
    const browserSampleRefreshBtn = document.getElementById("browser-sample-refresh-btn");
    const browserSamplesLoading = document.getElementById("browser-samples-loading");
    const replaceOverlay = document.getElementById("replace-sample-overlay");
    const replaceOverlayButtons = document.getElementById("replace-overlay-buttons");
    const replaceOverlayCancel = document.getElementById("replace-overlay-cancel");

    replaceOverlay.hidden = true;

    let sampleListByType = {};
    let filteredSamples = [];
    let selectedSampleIndex = -1;
    let replaceSamplePendingPath = null;

    function requestSamplesForType(type) {
      browserSamplesLoading.hidden = false;
      state.socket && state.socket.emit("getSamples", { type });
      setTimeout(() => {
        const listEl = document.getElementById("browser-sample-list");
        if (listEl) listEl.focus();
      }, 50);
    }

    function getPathSnippet(fullPath) {
      const parts = fullPath.replace(/\\/g, "/").split("/").filter(Boolean);
      const dirParts = parts.slice(0, -1);
      const last3 = dirParts.slice(-3);
      return last3.length > 0 ? ".../" + last3.join("/") : "";
    }

    function base64UrlEncode(str) {
      const bytes = new TextEncoder().encode(str);
      let binary = "";
      for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    function renderSampleList() {
      const type = currentSampleType;
      const list = sampleListByType[type] || [];
      const query = (browserSampleFilter.value || "").trim().toLowerCase();
      filteredSamples = query
        ? list.filter(
          (s) =>
            s.name.toLowerCase().includes(query) ||
            s.path.toLowerCase().includes(query)
        )
        : [...list];

      if (selectedSampleIndex >= filteredSamples.length) {
        selectedSampleIndex = Math.max(-1, filteredSamples.length - 1);
      }

      const label = SAMPLE_TYPE_LABELS[type] || type + "s";
      const envKeys = { kick: "DRUM_KICK_PATHS", snare: "DRUM_SNARE_PATHS", hihat: "DRUM_HIHAT_PATHS", clap: "DRUM_CLAP_PATHS", perc: "DRUM_PERC_PATHS", tom: "DRUM_TOM_PATHS", shaker: "DRUM_SHAKER_PATHS", cymbal: "DRUM_CYMBAL_PATHS" };
      const envKey = envKeys[type] || "DRUM_*_PATHS";
      const emptyMsg = list.length === 0
        ? `No ${label} found. Set ${envKey} in settings and click Refresh.`
        : "No matching samples";

      browserSampleList.innerHTML = "";
      if (filteredSamples.length === 0) {
        const li = document.createElement("li");
        li.className = "browser-list-empty";
        li.textContent = emptyMsg;
        browserSampleList.appendChild(li);
        return;
      }

      filteredSamples.forEach((sample, idx) => {
        const li = document.createElement("li");
        li.className = "browser-list-item";
        if (idx === selectedSampleIndex) li.classList.add("selected");
        li.title = sample.path;
        li.dataset.path = sample.path;
        li.dataset.index = String(idx);
        const swapBtn = document.createElement("span");
        swapBtn.className = "browser-list-item-swap";
        swapBtn.title = "Replace sample";
        swapBtn.innerHTML = "<i class=\"fa-solid fa-right-left\"></i>";
        swapBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          replaceSamplePendingPath = sample.path;
          showReplaceOverlay();
        });
        li.appendChild(swapBtn);
        const nameWrap = document.createElement("div");
        nameWrap.className = "browser-list-item-name-wrap";
        const nameSpan = document.createElement("span");
        nameSpan.className = "browser-list-item-name";
        nameSpan.textContent = sample.name;
        nameWrap.appendChild(nameSpan);
        const pathSnippet = getPathSnippet(sample.path);
        if (pathSnippet) {
          const pathSpan = document.createElement("span");
          pathSpan.className = "browser-list-item-path";
          pathSpan.textContent = pathSnippet;
          nameWrap.appendChild(pathSpan);
        }
        li.appendChild(nameWrap);
        const iconSpan = document.createElement("span");
        iconSpan.className = "browser-list-item-preview-icon";
        iconSpan.innerHTML = "<i class=\"fa-solid fa-volume-high\"></i>";
        li.appendChild(iconSpan);
        li.addEventListener("click", (e) => {
          if (e.target.closest(".browser-list-item-swap")) return;
          selectAndPreviewSample(idx);
        });
        browserSampleList.appendChild(li);
      });
    }

    function selectAndPreviewSample(idx) {
      if (idx < 0 || idx >= filteredSamples.length) return;
      selectedSampleIndex = idx;
      document.querySelectorAll("#browser-sample-list .browser-list-item").forEach((el, i) => {
        el.classList.toggle("selected", i === idx);
      });
      const sample = filteredSamples[idx];
      const li = browserSampleList.querySelector(`.browser-list-item[data-index="${idx}"]`);
      if (li) {
        showPreviewIndicator(li);
        li.scrollIntoView({ block: "nearest", behavior: "smooth" });
      }
      previewSample(sample.path);
      browserSampleList.focus();
    }

    function showPreviewIndicator(li) {
      li.classList.add("previewing");
      clearTimeout(li._previewIndicatorTimer);
      li._previewIndicatorTimer = setTimeout(() => {
        li.classList.remove("previewing");
      }, 450);
    }

    async function previewSample(path) {
      const enc = base64UrlEncode(path);
      const url = `/api/sample-preview?p=${encodeURIComponent(enc)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) return;
        const arrayBuffer = await res.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        if (audioCtx.state === "suspended") await audioCtx.resume();
        const source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioCtx.destination);
        source.start(0);
      } catch (e) {
        console.error("Preview failed", e);
      }
    }

    function showReplaceOverlay() {
      replaceOverlayButtons.innerHTML = "";
      ROWS.forEach((rowKey) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "replace-overlay-row-btn";
        btn.textContent = rowKey;
        btn.addEventListener("click", () => {
          if (replaceSamplePendingPath && state.socket && state.socket.connected) {
            const prev = getCurrentKitDescriptorForRow(rowKey);
            saveKitUndoState(rowKey, prev);
            state.socket.emit("replaceSampleWithPath", {
              row: rowKey,
              path: replaceSamplePendingPath,
            });
          }
          replaceSamplePendingPath = null;
          replaceOverlay.hidden = true;
        });
        replaceOverlayButtons.appendChild(btn);
      });
      replaceOverlay.hidden = false;
    }

    replaceOverlayCancel.addEventListener("click", () => {
      replaceSamplePendingPath = null;
      replaceOverlay.hidden = true;
    });

    browserSampleFilter.addEventListener("input", renderSampleList);
    browserSampleRefreshBtn.addEventListener("click", () => {
      if (state.socket && state.socket.connected) {
        browserSamplesLoading.hidden = false;
        state.socket.emit("refreshSamples", { type: currentSampleType });
      }
    });

    browserSampleList.addEventListener("keydown", (e) => {
      if (!browserTabSamples.hidden && filteredSamples.length > 0) {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          const next = Math.min(selectedSampleIndex + 1, filteredSamples.length - 1);
          selectAndPreviewSample(next);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          const prev = Math.max(selectedSampleIndex - 1, 0);
          selectAndPreviewSample(prev);
        }
      }
    });

    socket.on("samples", (data) => {
      browserSamplesLoading.hidden = true;
      const type = (data && data.type) || currentSampleType;
      sampleListByType[type] = (data && data.samples) ? [...data.samples] : [];
      if (type === currentSampleType) renderSampleList();
    });
  </script>
</body>

</html>
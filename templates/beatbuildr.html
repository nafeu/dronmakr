<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚îå dronmakr v{{ version }} ‚ñ† beatbuildr ‚îê</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•Å</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:ital@0;1&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    crossorigin="anonymous">
  <style>
    :root {
      --secondary: #000000;
      --primary: #ff9505;
      --theme-a: #353531;
      --theme-b: #016fb9;
      --theme-c: #ec4e20;
      --toolbar-height: 48px;
      --grid-cell-size: 28px;
      /* Width of the row/sample label column (header + each row); change to resize. */
      --grid-label-width: 280px;
    }

    body {
      background-color: var(--secondary);
      color: var(--primary);
      font-family: "Fragment Mono", monospace;
      padding: 1rem;
      padding-top: calc(var(--toolbar-height) + 1rem);
      user-select: none;
      -webkit-user-select: none;
    }

    #sequencer-grid,
    #sequencer-grid * {
      user-select: none;
      -webkit-user-select: none;
    }

    /* Themed scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--theme-a) var(--secondary);
    }

    *::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    *::-webkit-scrollbar-track {
      background: var(--secondary);
    }

    *::-webkit-scrollbar-thumb {
      background: var(--theme-a);
      border-radius: 4px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--theme-b);
    }

    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--toolbar-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      background-color: var(--secondary);
      border-bottom: 1px solid var(--theme-a);
      z-index: 1000;
    }

    #toolbar-brand {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--primary);
    }

    #toolbar-status {
      font-size: 0.75rem;
      color: var(--theme-b);
    }

    #app-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(220px, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    #main-column {
      border: 1px solid var(--theme-a);
      padding: 0.75rem;
      border-radius: 4px;
      background: #050505;
      overflow: auto;
    }

    #sidebar-column {
      border: 1px solid var(--theme-a);
      padding: 0.75rem;
      border-radius: 4px;
      background: #050505;
      min-height: 200px;
    }

    #sidebar-column h2 {
      margin: 0;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    #sidebar-column h2 i {
      font-size: 0.75rem;
    }

    #sidebar-empty-note {
      font-size: 0.75rem;
      color: var(--theme-a);
    }

    .transport-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .transport-btn {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid;
      flex-shrink: 0;
    }

    .transport-btn i {
      pointer-events: none;
    }

    .transport-btn-primary {
      background: var(--primary);
      color: var(--secondary);
      border-color: var(--primary);
    }

    .transport-btn-secondary {
      background: #050505;
      color: var(--primary);
      border-color: var(--theme-a);
    }

    .transport-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .transport-tempo {
      margin-bottom: 0.5rem;
    }

    .transport-tempo label {
      display: block;
      font-size: 0.7rem;
      color: var(--theme-a);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }

    .transport-tempo input[type="number"] {
      width: 100%;
      min-height: 2.5rem;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 1.25rem;
      font-weight: 600;
      background: #0a0a0a;
      border: 1px solid var(--theme-a);
      border-radius: 4px;
      color: var(--primary);
      box-sizing: border-box;
    }

    .transport-tempo input[type="number"]:focus {
      outline: none;
      border-color: var(--theme-b);
      box-shadow: 0 0 0 1px var(--theme-b);
    }

    #sequencer-grid {
      border-top: 1px solid var(--theme-a);
      border-left: 1px solid var(--theme-a);
      font-size: 0.7rem;
      overflow: auto;
    }

    .grid-row {
      display: grid;
      grid-template-columns: var(--grid-label-width) repeat(16, var(--grid-cell-size));
      align-items: stretch;
    }

    .grid-row-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0 0.4rem;
      border-right: 1px solid var(--theme-a);
      border-bottom: 1px solid var(--theme-a);
      background: #050505;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-label-main {
      text-transform: lowercase;
      color: var(--primary);
      flex-shrink: 0;
    }

    .row-label-sample-wrap {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      min-width: 0;
      flex: 1;
    }

    .row-label-sample {
      color: var(--theme-a);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-label-sample-refresh {
      flex-shrink: 0;
      width: 1.1rem;
      height: 1.1rem;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      cursor: pointer;
      color: var(--theme-a);
      font-size: 0.6rem;
    }

    .row-label-sample-refresh:hover {
      color: var(--primary);
      background: rgba(255, 149, 5, 0.15);
    }

    .grid-row-label:hover .row-label-sample-refresh {
      display: flex;
    }

    .grid-cell {
      border-right: 1px solid var(--theme-a);
      border-bottom: 1px solid var(--theme-a);
      cursor: pointer;
      background: #050505;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease, box-shadow 0.12s ease;
    }

    .grid-cell:hover {
      background: #111111;
      box-shadow: inset 0 0 0 1px var(--theme-b);
    }

    .grid-cell.active {
      background: var(--primary);
      box-shadow: inset 0 0 0 1px #000000;
    }

    .grid-cell.active:nth-child(4n+2) {
      /* Slight accent on off-beats when active */
      box-shadow: inset 0 0 0 1px var(--theme-c);
    }

    .grid-header {
      display: grid;
      grid-template-columns: var(--grid-label-width) repeat(16, var(--grid-cell-size));
      border-bottom: 1px solid var(--theme-a);
      background: #050505;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .grid-header-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--theme-a);
      padding: 0.2rem 0.4rem;
      border-right: 1px solid var(--theme-a);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .grid-header-label i {
      font-size: 0.6rem;
    }

    .grid-header-step {
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid var(--theme-a);
      padding: 0.15rem 0;
      color: var(--theme-a);
    }

    .grid-header-step.beat {
      color: var(--theme-b);
    }

    /* Playhead styling (header only) */
    .grid-header-step.playhead {
      background: var(--theme-b);
      color: var(--secondary);
    }
  </style>
</head>

<body>
  <header id="toolbar">
    <span id="toolbar-brand">‚îå dronmakr v{{ version }} ‚ñ† beatbuildr ‚îê</span>
    <span id="toolbar-status"><i class="fa-solid fa-spinner fa-spin"></i> connecting‚Ä¶</span>
  </header>

  <main id="app-layout">
    <section id="main-column">
      <div id="sequencer-grid"></div>
    </section>

    <aside id="sidebar-column">
      <h2><i class="fa-solid fa-sliders"></i> toolbar</h2>
      <div id="transport">
        <div class="transport-actions">
          <button type="button" id="undo-btn" class="transport-btn transport-btn-secondary" title="Undo last edit" disabled>
            <i class="fa-solid fa-undo"></i>
          </button>
          <button type="button" id="redo-btn" class="transport-btn transport-btn-secondary" title="Redo" disabled>
            <i class="fa-solid fa-redo"></i>
          </button>
          <button type="button" id="play-toggle" class="transport-btn transport-btn-primary" title="Play">
            <i class="fa-solid fa-play"></i>
          </button>
          <button type="button" id="stop-button" class="transport-btn transport-btn-secondary" title="Stop">
            <i class="fa-solid fa-stop"></i>
          </button>
          <button type="button" id="new-kit-btn" class="transport-btn transport-btn-secondary" title="Load new random drum kit">
            <i class="fa-solid fa-drum"></i>
          </button>
        </div>
        <div class="transport-tempo">
          <label for="tempo-input">Tempo (bpm)</label>
          <input type="number" id="tempo-input" min="40" max="240" value="120" title="Beats per minute">
        </div>
      </div>
    </aside>
  </main>

  <script>
    const ROWS = ["kick", "snar", "ghos", "clap", "hhat", "halt", "shkr", "prca", "prcb", "prcc", "tomm", "cymb"];
    const STEPS = 16;
    const BPM_MIN = 40;
    const BPM_MAX = 240;

    const state = {
      kit: null,
      pattern: {}, // { rowKey: [0/1,...] }
      buffers: {}, // { rowKey: AudioBuffer | null }
      bpm: 120,
      undoState: null,  // snapshot before last edit
      redoState: null,  // snapshot before we undid (so we can redo)
    };

    const dragState = {
      active: false,
      flippedKeys: null, // Set of "rowKey-step"
    };

    const toolbarStatusEl = document.getElementById("toolbar-status");
    const gridContainer = document.getElementById("sequencer-grid");
    const playToggleBtn = document.getElementById("play-toggle");
    const stopButton = document.getElementById("stop-button");
    const tempoInput = document.getElementById("tempo-input");
    const undoBtn = document.getElementById("undo-btn");
    const redoBtn = document.getElementById("redo-btn");

    function getStepDurationSec() {
      return 60 / state.bpm / 4; // 16th-note
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isPlaying = false;
    let currentStep = 0;
    let playIntervalId = null;

    function initEmptyPattern() {
      ROWS.forEach(row => {
        state.pattern[row] = new Array(STEPS).fill(0);
        state.buffers[row] = null;
      });
      state.undoState = null;
      state.redoState = null;
    }

    function deepCopyPattern() {
      const copy = {};
      ROWS.forEach(row => {
        copy[row] = state.pattern[row].slice();
      });
      return copy;
    }

    function saveUndoState() {
      state.redoState = null;
      state.undoState = deepCopyPattern();
      updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
      undoBtn.disabled = state.undoState === null;
      redoBtn.disabled = state.redoState === null;
    }

    function undo() {
      if (state.undoState === null) return;
      state.redoState = deepCopyPattern();
      ROWS.forEach(row => {
        state.pattern[row] = state.undoState[row].slice();
      });
      state.undoState = null;
      updateUndoRedoButtons();
      renderGrid();
    }

    function redo() {
      if (state.redoState === null) return;
      state.undoState = deepCopyPattern();
      ROWS.forEach(row => {
        state.pattern[row] = state.redoState[row].slice();
      });
      state.redoState = null;
      updateUndoRedoButtons();
      renderGrid();
    }

    function renderGrid() {
      gridContainer.innerHTML = "";

      const header = document.createElement("div");
      header.className = "grid-header";

      const headerLabel = document.createElement("div");
      headerLabel.className = "grid-header-label";
      headerLabel.innerHTML = "<i class=\"fa-solid fa-table-cells\"></i> sample";
      header.appendChild(headerLabel);

      for (let step = 0; step < STEPS; step++) {
        const stepEl = document.createElement("div");
        stepEl.className = "grid-header-step";
        const isQuarter = step % 4 === 0;
        if (isQuarter) {
          stepEl.classList.add("beat");
        }
        stepEl.textContent = step + 1;
        header.appendChild(stepEl);
      }

      gridContainer.appendChild(header);

      ROWS.forEach((rowKey) => {
        const rowWrapper = document.createElement("div");
        rowWrapper.className = "grid-row";

        const rowLabel = document.createElement("div");
        rowLabel.className = "grid-row-label";

        const mainLabel = document.createElement("span");
        mainLabel.className = "row-label-main";
        mainLabel.textContent = rowKey;
        rowLabel.appendChild(mainLabel);

        const sampleWrap = document.createElement("div");
        sampleWrap.className = "row-label-sample-wrap";

        const sampleLabel = document.createElement("span");
        sampleLabel.className = "row-label-sample";
        const sampleDescriptor = state.kit && state.kit.kit && state.kit.kit[rowKey];
        const sampleName = sampleDescriptor && sampleDescriptor.name
          ? sampleDescriptor.name
          : "no sample";
        sampleLabel.textContent = sampleName;
        sampleLabel.title = sampleName;
        sampleWrap.appendChild(sampleLabel);

        const refreshBtn = document.createElement("span");
        refreshBtn.className = "row-label-sample-refresh";
        refreshBtn.title = "Replace with another random sample";
        refreshBtn.setAttribute("aria-label", "Replace sample");
        refreshBtn.innerHTML = "<i class=\"fa-solid fa-arrow-rotate-right\"></i>";
        refreshBtn.dataset.row = rowKey;
        refreshBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (state.socket && state.socket.connected) {
            state.socket.emit("replaceSample", { row: rowKey });
          }
        });
        sampleWrap.appendChild(refreshBtn);

        rowLabel.appendChild(sampleWrap);
        rowWrapper.appendChild(rowLabel);

        for (let step = 0; step < STEPS; step++) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          if (state.pattern[rowKey][step] === 1) {
            cell.classList.add("active");
          }

          cell.dataset.row = rowKey;
          cell.dataset.step = step.toString();

          rowWrapper.appendChild(cell);
        }

        gridContainer.appendChild(rowWrapper);
      });
    }

    function flipCell(rowKey, stepIndex) {
      const current = state.pattern[rowKey][stepIndex];
      const next = current === 1 ? 0 : 1;
      state.pattern[rowKey][stepIndex] = next;
      const cell = gridContainer.querySelector(`.grid-cell[data-row="${rowKey}"][data-step="${stepIndex}"]`);
      if (cell) {
        if (next === 1) {
          cell.classList.add("active");
        } else {
          cell.classList.remove("active");
        }
      }
    }

    function setupGridDrag() {
      gridContainer.addEventListener("mousedown", (e) => {
        const cell = e.target.closest(".grid-cell");
        if (!cell) return;
        e.preventDefault();
        const rowKey = cell.dataset.row;
        const stepIndex = parseInt(cell.dataset.step, 10);
        saveUndoState();
        dragState.active = true;
        dragState.flippedKeys = new Set();
        const key = `${rowKey}-${stepIndex}`;
        dragState.flippedKeys.add(key);
        flipCell(rowKey, stepIndex);
      });
    }

    document.addEventListener("mousemove", (e) => {
      if (!dragState.active) return;
      const cell = e.target.closest(".grid-cell");
      if (!cell) return;
      const rowKey = cell.dataset.row;
      const stepIndex = parseInt(cell.dataset.step, 10);
      const key = `${rowKey}-${stepIndex}`;
      if (dragState.flippedKeys.has(key)) return;
      dragState.flippedKeys.add(key);
      flipCell(rowKey, stepIndex);
    });

    document.addEventListener("mouseup", () => {
      dragState.active = false;
      dragState.flippedKeys = null;
    });

    initEmptyPattern();
    renderGrid();
    updateUndoRedoButtons();

    setupGridDrag();

    const socket = io("http://localhost:3767");
    state.socket = socket;

    socket.on("connect", () => {
      toolbarStatusEl.innerHTML = "<i class=\"fa-solid fa-link\"></i> connected";
    });

    socket.on("disconnect", () => {
      toolbarStatusEl.innerHTML = "<i class=\"fa-solid fa-unlink\"></i> disconnected";
    });

    async function loadBufferForRow(rowKey, url) {
      try {
        const res = await fetch(url);
        const arrayBuffer = await res.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        state.buffers[rowKey] = audioBuffer;
      } catch (e) {
        console.error("Failed to load sample for", rowKey, e);
        state.buffers[rowKey] = null;
      }
    }

    async function hydrateKitBuffers(kit) {
      if (!kit || !kit.kit) return;
      const tasks = [];
      ROWS.forEach((rowKey) => {
        const desc = kit.kit[rowKey];
        if (desc && desc.url) {
          tasks.push(loadBufferForRow(rowKey, desc.url));
        } else {
          state.buffers[rowKey] = null;
        }
      });
      await Promise.all(tasks);
    }

    socket.on("kit", async (data) => {
      state.kit = data;
      await hydrateKitBuffers(data);
      renderGrid();
      console.log("Received drum kit:", data);
    });

    socket.on("sampleReplaced", async (data) => {
      if (!data || !data.row || !state.kit || !state.kit.kit) return;
      const rowKey = data.row;
      state.kit.kit[rowKey] = { name: data.name, path: data.path, url: data.url };
      await loadBufferForRow(rowKey, data.url);
      renderGrid();
    });

    document.getElementById("new-kit-btn").addEventListener("click", () => {
      if (socket.connected) socket.emit("requestNewKit");
    });

    function clearPlayhead() {
      document.querySelectorAll(".grid-header-step.playhead").forEach(el => el.classList.remove("playhead"));
    }

    function updatePlayhead(stepIndex) {
      clearPlayhead();

      const headerSteps = document.querySelectorAll(".grid-header-step");
      headerSteps.forEach((el, idx) => {
        if (idx === stepIndex) {
          el.classList.add("playhead");
        }
      });
    }

    function scheduleStep(stepIndex) {
      const when = audioCtx.currentTime + 0.05; // small lookahead
      ROWS.forEach(rowKey => {
        const patternRow = state.pattern[rowKey];
        const buffer = state.buffers[rowKey];
        if (!patternRow || !buffer) return;
        if (patternRow[stepIndex] !== 1) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(when);
      });
    }

    function advanceStep() {
      updatePlayhead(currentStep);
      scheduleStep(currentStep);
      currentStep = (currentStep + 1) % STEPS;
    }

    async function startPlayback() {
      if (isPlaying) return;
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      isPlaying = true;
      currentStep = 0;
      playToggleBtn.innerHTML = "<i class=\"fa-solid fa-pause\"></i>";
      playToggleBtn.title = "Pause";

      advanceStep();
      playIntervalId = setInterval(advanceStep, getStepDurationSec() * 1000);
    }

    function restartPlaybackInterval() {
      if (!isPlaying || playIntervalId === null) return;
      clearInterval(playIntervalId);
      playIntervalId = setInterval(advanceStep, getStepDurationSec() * 1000);
    }

    function stopPlayback() {
      if (!isPlaying) {
        clearPlayhead();
        currentStep = 0;
        return;
      }
      isPlaying = false;
      playToggleBtn.innerHTML = "<i class=\"fa-solid fa-play\"></i>";
      playToggleBtn.title = "Play";
      if (playIntervalId !== null) {
        clearInterval(playIntervalId);
        playIntervalId = null;
      }
      clearPlayhead();
      currentStep = 0;
    }

    playToggleBtn.addEventListener("click", () => {
      if (isPlaying) {
        stopPlayback();
      } else {
        startPlayback();
      }
    });

    stopButton.addEventListener("click", () => {
      stopPlayback();
    });

    tempoInput.addEventListener("change", () => {
      let val = parseInt(tempoInput.value, 10);
      if (Number.isNaN(val)) val = state.bpm;
      state.bpm = Math.max(BPM_MIN, Math.min(BPM_MAX, val));
      tempoInput.value = state.bpm;
      if (isPlaying) restartPlaybackInterval();
    });

    tempoInput.addEventListener("input", () => {
      let val = parseInt(tempoInput.value, 10);
      if (!Number.isNaN(val)) {
        state.bpm = Math.max(BPM_MIN, Math.min(BPM_MAX, val));
        if (isPlaying) restartPlaybackInterval();
      }
    });

    undoBtn.addEventListener("click", undo);
    redoBtn.addEventListener("click", redo);
  </script>
</body>

</html>